name: Build Android Library

run-name: Build for Android ${{ inputs.library_name }}@${{ inputs.library_version }} RN@${{ inputs.react_native_version }}${{ inputs.worklets_version && format(' with worklets@{0}', inputs.worklets_version) || '' }}${{ inputs.test_run_snapshot && ' - snapshot' || '' }}

on:
  workflow_dispatch:
    inputs:
      library_name:
        description: 'Library name (from NPM)'
        required: true
        type: string
      library_version:
        description: 'Library version (from NPM)'
        required: true
        type: string
      react_native_version:
        description: 'React Native version'
        required: true
        type: string
      worklets_version:
        description: 'Worklets version'
        required: false
        type: string
      test_run_snapshot:
        description: 'Test build for snapshot repository publishing'
        required: false
        type: boolean
        default: false

jobs:
  build-library-android:
    runs-on: rnrepo-builder-ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: âœ… Accept Android Licenses
        run: |
          yes | sdkmanager --licenses || true

      - name: ğŸ— Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: â™»ï¸ Restore RN project cache
        id: rn-project-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ runner.temp }}/rnrepo_build_app
          key: ${{ runner.os }}-rn-project-cache-${{ inputs.react_native_version }}

      - name: ğŸ“± Create RN project (cache miss)
        if: steps.rn-project-cache.outputs.cache-hit != 'true'
        run: |
          work_dir="${{ runner.temp }}"
          mkdir -p "$work_dir"
          cd "$work_dir"
          bunx @react-native-community/cli@latest init rnrepo_build_app --version "${{ inputs.react_native_version }}" --skip-install
          cd "$work_dir/rnrepo_build_app"
          npm install

      - name: ğŸ’¾ Save RN project cache (clean)
        if: steps.rn-project-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ runner.temp }}/rnrepo_build_app
          key: ${{ runner.os }}-rn-project-cache-${{ inputs.react_native_version }}

      - name: ğŸ”¨ Build library for Android
        run: bun run packages/builder/build-library-android.ts -- "${{ inputs.library_name }}" "${{ inputs.library_version }}" "${{ inputs.react_native_version }}" "${{ runner.temp }}" "${{ inputs.worklets_version }}"

      - name: ğŸ“‹ List artifacts with checksums
        run: |
          find ~/.m2/repository/org/rnrepo/public -type f -exec md5sum {} \;

      - name: ğŸ“¦ Upload Maven artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            ~/.m2/repository/org/rnrepo/public
          retention-days: 1
