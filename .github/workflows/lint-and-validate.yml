name: Lint, Test and Validate

run-name: Lint, test sources and validate json

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-and-validate:
    runs-on: rnrepo-ubuntu-latest
    timeout-minutes: 60
    permissions:
      actions: read
      contents: read
      pull-requests: read
    outputs:
      typescript: ${{ steps.filter.outputs.typescript }}
      kotlin: ${{ steps.filter.outputs.kotlin }}
      json: ${{ steps.filter.outputs.json }}
    concurrency:
      group: lint-and-validate-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            typescript:
              - '**/*.ts'
              - '**/*.tsx'
              - '.github/workflows/lint-and-validate.yml'
            kotlin:
              - 'packages/gradle-client/**'
              - '.github/workflows/lint-and-validate.yml'
            json:
              - '*.json'
              - '.github/workflows/lint-and-validate.yml'

      - name: ğŸ— Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ—ƒï¸ Cache Bun and Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-bun-gradle-${{ hashFiles('**/bun.lock', '**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-bun-gradle-

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ” Lint kotlin
        if: ${{ steps.filter.outputs.kotlin == 'true' }}
        run: bun run lint-gradle-client

      - name: ğŸ” Lint typescript
        if: ${{ steps.filter.outputs.typescript == 'true' }}
        run: bun run lint-ts

      - name: âœ… Validate JSON files
        if: ${{ steps.filter.outputs.json == 'true' }}
        run: bun run validate

      - name: ğŸ§ª Run gradle-client tests
        if: ${{ steps.filter.outputs.kotlin == 'true' }}
        run: bun run test-gradle-client

      - name: ğŸ§ª Run ts tests
        if: ${{ steps.filter.outputs.typescript == 'true' }}
        run: bun test
