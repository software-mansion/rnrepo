name: Build iOS Library

run-name: Build for iOS ${{ inputs.library_name }}@${{ inputs.library_version }} RN@${{ inputs.react_native_version }}${{ inputs.worklets_version && format(' with worklets@{0}', inputs.worklets_version) || '' }}${{ inputs.configuration && format(' [{0}]', inputs.configuration) || '' }}${{ inputs.test_run_snapshot && ' - snapshot' || '' }}

on:
  workflow_dispatch:
    inputs:
      library_name:
        description: 'Library name (from NPM)'
        required: true
        type: string
      library_version:
        description: 'Library version (from NPM)'
        required: true
        type: string
      react_native_version:
        description: 'React Native version'
        required: true
        type: string
      configuration:
        description: 'Build configuration'
        required: true
        type: choice
        options:
          - debug
          - release
      worklets_version:
        description: 'Worklets version'
        required: false
        type: string
      test_run_snapshot:
        description: 'Test build for snapshot repository publishing'
        required: false
        type: boolean
        default: false

jobs:
  build-library-ios:
    runs-on: macos-latest
    # runs-on: rnrepo-builder-macos-14
    timeout-minutes: 60

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: Use latest stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1'
      
      - name: Install Ruby gems
        run: gem install cocoapods -v 1.15.2
      
      - name: ğŸ— Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ”¨ Build library for iOS
        run: bun run packages/builder/build-library-ios.ts -- "${{ inputs.library_name }}" "${{ inputs.library_version }}" "${{ inputs.react_native_version }}" "${{ inputs.configuration }}" "${{ runner.temp }}" "${{ inputs.worklets_version }}"

      - name: ğŸ“¦ Upload framework artifacts
        uses: actions/upload-artifact@v4
        with:
          name: framework-artifacts
          path: ${{ runner.temp }}/outputs/
          retention-days: 1
