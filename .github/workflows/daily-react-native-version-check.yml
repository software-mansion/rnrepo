name: Daily React Native Version Check

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-react-native-version:
    runs-on: rnrepo-ubuntu-latest
    name: Check for new React Native versions

    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ” Check and update React Native versions
        id: update-versions
        run: bun run packages/scheduler/src/update-react-native-versions.ts

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“¤ Commit changes if exists
        run: |
          if git diff --quiet react-native-versions.json; then
            echo "No changes to commit"
            exit 0
          else
            git add react-native-versions.json
            git commit -m "[BOT] Update React Native versions"
          fi

      - name: ğŸ“ Create or update branch
        run: |
          BRANCH_NAME="chore/update-react-native-versions"
          
          # Check if branch exists
          if git show-ref --quiet refs/heads/$BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists. Exiting to avoid conflicts."
            exit 1
          else
            git checkout -b $BRANCH_NAME
          fi

      - name: ğŸ”„ Create or update Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update React Native versions"
          title: "chore: update React Native versions"
          body: |
            ## ğŸš€ React Native Version Update
            
            This PR updates the React Native versions list with newly released versions.
            
            _This is an automated PR generated by the daily version check workflow._
          branch: chore/update-react-native-versions
          delete-branch: true
